/*! contextual-comments 2014-02-27 00:44:35 */
(function(){"use strict";var a,b,c,d,e=function(a,b){return function(){return a.apply(b,arguments)}};try{if("undefined"==typeof $||null===$)throw"You must include jQuery";if("undefined"==typeof _||null===_)throw"You must include undescore"}catch(f){d=f,console.warn("Error : "+d)}window.gc||(window.gc={}),window.gc.comments||(window.gc.comments={}),_.extend(_,{subpart:function(a,b){var c,d;return d=!1,c="",$(a).toArray().forEach(function(a){var e;return"#comment"!==a.nodeName&&d?(e=a.outerHTML?a.outerHTML:a.textContent,c+=e.replace(/[\n\r\t]/g,"").trim()):"#comment"===a.nodeName&&(a.data.trim()===b+" template start"&&(d=!0),a.data.trim()===b+" template end")?d=!1:void 0}),_.unescape(c)}}),a=function(){function a(a){return this._click=e(this._click,this),this._out=e(this._out,this),this._hover=e(this._hover,this),this._hide=e(this._hide,this),this._show=e(this._show,this),this._initVars(a)._refreshLabel()._render()._binds(),this}return a.prototype._initVars=function(a){return this._cc=(null!=a?a.cc:void 0)||null,this._target=$(null!=a?a.target:void 0)||null,this._target&&(this._index=this._target.index()),this},a.prototype._refreshLabel=function(){var a;return a=this._cc._getCommentsByIndex(this._index),this._commentLength=a.length,this._label=this._commentLength?this._commentLength:"+",this._render(),this},a.prototype._getPosition=function(){var a,b;return b=$(this._target),a=b.offset(),{top:a.top,left:a.left+b.outerWidth()+this._cc.gapBetweenButtonAndList}},a.prototype._show=function(a){var b;return b=$(a.target),this._isShown=!0,this._el.fadeIn("fast"),b},a.prototype._hide=function(a){var b,c,d,e;return c=$(a.target),d=this,b=null!=(e=a.data)?e.force:void 0,this._isShown=this._commentLength,!this._isShown&&b?this._el.fadeOut(0):setTimeout(function(){return d._isShown?void 0:d._el.fadeOut("fast")},1e3),c},a.prototype._hover=function(a){var b;return b=$(a.target),this._isShown=!0,b.addClass("comment-active"),b},a.prototype._out=function(a){var b;return b=$(a.target),b.removeClass("comment-active"),b},a.prototype._click=function(a){var b;return b=$(a.target),this._cc.dispatcher.trigger("hideAllLists"),this._cc.dispatcher.trigger("showList",this._target),b},a.prototype._binds=function(){return this._el.on("mouseenter",this._show).on("mouseenter",this._hover).on("mouseleave",this._out).on("click",this._click),this._target.on("mouseenter",this._show).on("mouseout",this._hide),this},a.prototype._render=function(){var a;return this._el=$(_.template(this._cc._buttonView,{label:this._label})),a=this._getPosition(),this._el.css({top:a.top,left:a.left}).appendTo(this._cc._container),this._hide({data:{force:!0}}),this},a}(),("undefined"!=typeof module&&null!==module?module.exports:void 0)?exports.gc.comments.Button=a:window.gc.comments.Button=a,c=function(){function a(a){return this._hide=e(this._hide,this),this._show=e(this._show,this),this._initVars(a)._retrieveComments()._build()._binds(),this}return a.prototype._comments=[],a.prototype._initVars=function(a){return this._cc=(null!=a?a.cc:void 0)||null,this._target=(null!=a?a.target:void 0)||null,this._target&&(this._target=$(this._target),this._index=this._target.index()),this},a.prototype._retrieveComments=function(){return this._cc&&(this._comments=this._cc._getCommentsByIndexAndParentId(this._index,0)),this},a.prototype._getPosition=function(){var a,b;return b=$(this._target),a=b.offset(),{top:a.top,left:a.left+b.outerWidth()-this._el.outerWidth()}},a.prototype._show=function(a,b){var c;return b===this._target.get(0)&&(this._el.appendTo(this._cc._container),c=this._getPosition(),this._el.css({top:c.top,left:c.left})),a.target},a.prototype._hide=function(){return this._el&&this._el.detach(),this},a.prototype._binds=function(){return this._cc.dispatcher.on("showList",this._show),this._cc.dispatcher.on("hideAllLists",this._hide),this},a.prototype._build=function(){return this._el=$(_.template(this._cc._listView,{comments:this._comments})),this},a}(),("undefined"!=typeof module&&null!==module?module.exports:void 0)?exports.gc.comments.List=c:window.gc.comments.List=c,b=function(){function a(a){return this._initVars(a)._initTemplates(),this}return a.prototype.target="body",a.prototype.selector="p, img, li",a.prototype.containerId="comments-container",a.prototype.comments=[],a.prototype.gapBetweenButtonAndList=20,a.prototype.dispatcher=$({}),a.prototype.templateFile="./templates/template.html",a.prototype._buttons=[],a.prototype._lists=[],a.prototype._availableOptions=["target","selector","containerId","comments","gapBetweenButtonAndList","templateFile"],a.prototype._initVars=function(a){return _.extend(this,_.pick(a,this._availableOptions)),"string"==typeof this.target&&(this.target=$(this.target)),this},a.prototype._initTemplates=function(){var a;return a=this,$.ajax(this.templateFile).success(function(b){return a._containerView=_.subpart(b,"container"),a._buttonView=_.subpart(b,"button"),a._listView=_.subpart(b,"list"),a._commentView=_.subpart(b,"comment"),a._render()}),this},a.prototype._getCommentsByIndexAndParentId=function(a,b){var c,d;return c=[],d=this,this.comments.forEach(function(e){return e.index===a&&e.parentId===b?(e.children=d._getCommentsByIndexAndParentId(a,e.uid),c.push(e)):void 0}),c},a.prototype._getCommentsByIndex=function(a){var b,c;return b=[],c=this,this.comments.forEach(function(c){return c.index===a?b.push(c):void 0}),b},a.prototype._build=function(){var a;return a=this,this.target.find(this.selector).each(function(){var b,c;return b=new gc.comments.Button({cc:a,target:this}),a._buttons.push(b),c=new gc.comments.List({cc:a,target:this}),a._lists.push(c)}),this},a.prototype._render=function(){return this._container=$(_.template(this._containerView,{container:this.containerId})),this._container.appendTo("body"),this._build(),this},a}(),("undefined"!=typeof module&&null!==module?module.exports:void 0)?exports.gc.Contextualcomments=b:window.gc.Contextualcomments=b}).call(this);